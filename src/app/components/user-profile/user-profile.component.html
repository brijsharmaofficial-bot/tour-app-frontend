<app-navbar />
<div class="container py-5">
  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading && user" class="row">
    <!-- Sidebar -->
    <div class="col-12 col-md-4 col-lg-3 mb-4 mb-md-0">
      <div class="card h-100 shadow-sm">
        <div class="card-body text-center">
          <img src="https://ui-avatars.com/api/?name={{ user?.name }}&background=random" 
               alt="Avatar" 
               class="rounded-circle mb-3" 
               width="90" 
               height="90">
          <h5 class="mb-1">{{ user?.name }}</h5>
          <p class="text-muted small mb-2">{{ user?.email }}</p>
          <p class="text-muted small mb-2" *ngIf="user?.phone">
            üì± {{ user?.phone }}
          </p>
          <button class="btn btn-outline-primary btn-sm mb-3" (click)="logout()">Logout</button>
          <hr>
          
          <!-- Tabs -->
          <div class="nav flex-column nav-pills gap-2">
            <button class="nav-link text-start" 
                    [class.active]="activeTab === 'profile'" 
                    (click)="setActiveTab('profile')">
              üë§ Profile
            </button>
            <button class="nav-link text-start" 
                    [class.active]="activeTab === 'bookings'" 
                    (click)="setActiveTab('bookings')">
              üìã My Bookings ({{ stats.total_bookings || 0 }})
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-12 col-md-8 col-lg-9">
      <div class="card shadow-sm">
        <div class="card-body">
          
          <!-- Profile Tab -->
          <div *ngIf="activeTab === 'profile'" class="tab-content">
            <h4 class="mb-4">Profile Information</h4>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label text-muted">Full Name</label>
                  <p class="fs-5">{{ user?.name }}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted">Email Address</label>
                  <p class="fs-5">{{ user?.email }}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted">Phone Number</label>
                  <p class="fs-5">{{ user?.phone || 'Not provided' }}</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label text-muted">Member Since</label>
                  <p class="fs-5">{{ user?.member_since || formatDate(user?.created_at) }}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted">Total Bookings</label>
                  <p class="fs-5">{{ user?.total_bookings || stats.total_bookings || 0 }}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted">Total Spent</label>
                  <p class="fs-5">‚Çπ{{ (user?.total_spent || 0) | number }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Bookings Tab -->
          <div *ngIf="activeTab === 'bookings'" class="tab-content">
            <h4 class="mb-4">My Bookings</h4>

            <!-- Stats -->
            <div class="row g-3 mb-4">
              <div class="col-6 col-md-3">
                <div class="card text-center p-3">
                  <div class="text-success fw-bold fs-4">{{ stats.total_bookings || 0 }}</div>
                  <div class="text-muted small">Total</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card text-center p-3">
                  <div class="text-primary fw-bold fs-4">{{ stats.completed_bookings || 0 }}</div>
                  <div class="text-muted small">Completed</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card text-center p-3">
                  <div class="text-warning fw-bold fs-4">‚Çπ{{ stats.total_paid || 0 | number }}</div>
                  <div class="text-muted small">Paid</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card text-center p-3">
                  <div class="text-danger fw-bold fs-4">‚Çπ{{ stats.total_remaining || 0 | number }}</div>
                  <div class="text-muted small">Remaining</div>
                </div>
              </div>
            </div>

            <!-- Bookings List -->
            <div *ngIf="bookings.length > 0; else noBookings">
              <div class="list-group">
                <div *ngFor="let booking of bookings" class="list-group-item mb-3 border rounded">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <!-- Booking Header -->
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                          <h6 class="mb-1">{{ booking.car }}
                            <span class="badge bg-secondary ms-2">{{ booking.car_type }}</span>
                          </h6>
                          <div class="text-muted small">
                            Booking ID: <strong>#{{ booking.booking_reference }}</strong>
                          </div>
                        </div>
                        <div class="text-end">
                          <div class="fw-bold text-primary fs-5">‚Çπ{{ booking.price | number }}</div>
                          <div class="text-muted small">
                            Booked: {{ formatDate(booking.created_at) }}
                          </div>
                        </div>
                      </div>

                      <!-- Trip Details -->
                      <div class="row g-3 mb-3">
                        <div class="col-md-6">
                          <div class="card bg-light border-0 p-3 h-100">
                            <div class="row g-2">
                              
                              @if(booking.trip_type==='oneway'){
                                <div class="col-6">
                                  <div class="text-muted small">From</div>
                                  <div class="fw-bold">{{ booking.from }}, {{booking.fromstate}}</div>
                                </div>
                                <div class="col-6">
                                  <div class="text-muted small">To</div>
                                  <div class="fw-bold">{{ booking.to }}, {{booking.fromstate}}</div>
                                </div>
                              }
                              @if(booking.trip_type==='roundtrip'){
                                <div class="col-6">
                                  <div class="text-muted small">From</div>
                                  <div class="fw-bold">{{ booking.from }}</div>
                                </div>
                                <div class="col-6">
                                  <div class="text-muted small">To</div>
                                  <div class="fw-bold">{{ booking.to }}, {{booking.tostate}}</div>
                                </div>
                              }
                              @if(booking.trip_type==='local'){
                                <div class="col-6">
                                  <div class="text-muted small">Itinerary</div>
                                  <div class="fw-bold">{{ booking.from }}, {{booking.fromstate}} </div>
                                </div>
                                <div class="col-6">
                                  <div class="text-muted small">Car Type</div>
                                  <div class="fw-bold">{{ booking.car }} or Equivalent</div>
                                </div>
                              }
                              @if(booking.trip_type==='airport'){
                                <div class="col-6">
                                  <div class="text-muted small">Itinerary</div>
                                  <div class="fw-bold">{{ booking.from }}, {{booking.fromstate}} </div>
                                </div>
                                <div class="col-6">
                                  <div class="text-muted small">Car Type</div>
                                  <div class="fw-bold">{{ booking.car }} or Equivalent</div>
                                </div>
                              }
                              
                              <div class="col-6">
                                <div class="text-muted small">Pickup Date</div>
                                <div>{{ booking.pickup_date }}</div>
                              </div>
                              <div class="col-6">
                                <div class="text-muted small">Pickup Time</div>
                                <div>{{ booking.pickup_time }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <div class="col-md-6">
                          <div class="card bg-light border-0 p-3 h-100">
                            <div class="row g-2">
                              <div class="col-6">
                                <div class="text-muted small">Trip Type</div>
                                <div class="fw-bold">{{ booking.type }}</div>

                              </div>
                              <div class="col-6"> 
                                @if(booking.trip_type === 'local'){
                                  <div class="text-muted small">Package</div>
                                   <div>{{booking.hours}} Hr | {{ booking.distance_km | number}} Km</div>
                                }
                                @if(booking.trip_type === 'airport'){
                                  <div class="text-muted small">Distance Included</div>
                                   <div>{{ booking.distance_km | number }} Km</div>
                                }
                                @if(booking.trip_type === 'roundtrip'){
                                  <div class="text-muted small">Distance Included</div>
                                  <div>{{ booking.distance_km | number }} km</div>
                                }
                                @if(booking.trip_type === 'oneway'){
                                  <div class="text-muted small">Distance Included</div>
                                  <div>{{ booking.distance_km | number }} km</div>
                                }
                              </div>
                              <!-- <div class="col-6">
                                
                                <div>{{ booking.package }}</div>
                              </div> -->
                              <div class="col-6">
                                <div class="text-muted small">Pickup Location</div>
                                <div class="text-truncate" [title]="booking.pickup_location">
                                  {{ booking.pickup_location }}
                                </div>
                              </div>
                              <div class="col-6">
                                <div class="text-muted small">Drop Location</div>
                                <div class="text-truncate" [title]="booking.drop_location">
                                  {{ booking.drop_location }}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Status & Actions -->
                      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mt-3 pt-3 border-top">
                        <div class="mb-2 mb-md-0">
                          <div class="d-flex flex-wrap align-items-center gap-2">
                            <span [class]="getStatusBadgeClass(booking.booking_status)" class="me-2">
                              {{ booking.booking_status }}
                            </span>
                            <span [class]="getPaymentBadgeClass(booking.payment_status)">
                              {{ booking.payment_status }}
                            </span>
                            <span class="badge bg-info">{{ booking.type }}</span>
                            
                            <!-- Payment Details -->
                            <div *ngIf="booking.payment_status === 'Partial'" class="ms-2">
                              <span class="text-muted small">
                                Paid: ‚Çπ{{ booking.advanced_amount | number }} | 
                                Remaining: ‚Çπ{{ booking.price - booking.advanced_amount | number }}
                              </span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2">
                          <!-- Invoice Button -->
                          <button class="btn btn-sm btn-outline-success" 
                                  (click)="downloadInvoice(booking)"
                                  title="Download Invoice">
                            üìÑ Invoice
                          </button>
                          
                          <!-- Cancel Button -->
                          <button *ngIf="booking.booking_status === 'Pending' || booking.booking_status === 'Confirmed'"
                                  class="btn btn-sm btn-outline-danger"
                                  (click)="cancelBooking(booking)"
                                  title="Cancel Booking">
                            ‚ùå Cancel
                          </button>
                          
                          <!-- Pay Remaining Button -->
                          <button *ngIf="booking.payment_status === 'Partial' || booking.payment_status === 'Pending'"
                                  class="btn btn-sm btn-primary"
                                  (click)="payRemaining(booking)"
                                  title="Pay Remaining Amount">
                            üí≥ Pay ‚Çπ{{ booking.price - booking.advanced_amount | number }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Pagination (Optional) -->
              <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted small">
                  Showing {{ bookings.length }} of {{ stats.total_bookings }} bookings
                </div>
                <nav *ngIf="bookings.length > 5">
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled">
                      <a class="page-link" href="#" tabindex="-1">Previous</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                      <a class="page-link" href="#">Next</a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>

            <ng-template #noBookings>
              <div class="text-center py-5">
                <div class="mb-3">
                  <i class="bi bi-calendar-x fs-1 text-muted"></i>
                </div>
                <h5>No Bookings Yet</h5>
                <p class="text-muted mb-4">You haven't made any bookings yet.</p>
                <button class="btn btn-primary btn-lg" routerLink="/">
                  üöó Book Your First Ride
                </button>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<app-footer />